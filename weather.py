"""–°–∏—Å—Ç–µ–º–∞ –ø–æ–≥–æ–¥—ã –¥–ª—è –∏–≥—Ä—ã"""
import random
import hashlib
from datetime import datetime, timedelta
from typing import Dict, Tuple
from config import get_current_season

class WeatherSystem:
    """–°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–≥–æ–¥–æ–π"""
    
    # –ü–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
    WEATHER_CONDITIONS = {
        '–Ø—Å–Ω–æ': {'emoji': '‚òÄÔ∏è', 'name': '–Ø—Å–Ω–æ', 'bonus': -10},           # –°–æ–ª–Ω–µ—á–Ω–æ - —Ä—ã–±–∞ –∞–∫—Ç–∏–≤–Ω–µ–µ –ø—Ä—è—á–µ—Ç—Å—è
        '–û–±–ª–∞—á–Ω–æ': {'emoji': '‚õÖ', 'name': '–û–±–ª–∞—á–Ω–æ', 'bonus': 5},        # –ü–∞—Å–º—É—Ä–Ω–æ - –Ω–æ—Ä–º–∞–ª—å–Ω–æ
        '–ü–∞—Å–º—É—Ä–Ω–æ': {'emoji': '‚òÅÔ∏è', 'name': '–ü–∞—Å–º—É—Ä–Ω–æ', 'bonus': 15},     # –ü–∞—Å–º—É—Ä–Ω–æ - —Ä—ã–±–∞ –∫–ª—é—ë—Ç –ª—É—á—à–µ
        '–î–æ–∂–¥—å': {'emoji': 'üåßÔ∏è', 'name': '–î–æ–∂–¥—å', 'bonus': 10},          # –î–æ–∂–¥—å - —Ö–æ—Ä–æ—à–æ –∫–ª—é—ë—Ç
        '–°–Ω–µ–≥': {'emoji': '‚ùÑÔ∏è', 'name': '–°–Ω–µ–≥', 'bonus': 5},              # –°–Ω–µ–≥ - –∫–∞–∫ –æ–±–ª–∞—á–Ω–æ
        '–¢—É–º–∞–Ω': {'emoji': 'üå´Ô∏è', 'name': '–¢—É–º–∞–Ω', 'bonus': 20},           # –¢—É–º–∞–Ω - –æ—Ç–ª–∏—á–Ω—ã–π –∫–ª—ë–≤
        '–ì—Ä–æ–∑–∞': {'emoji': '‚õàÔ∏è', 'name': '–ì—Ä–æ–∑–∞', 'bonus': -30},          # –ì—Ä–æ–∑–∞ - –æ–ø–∞—Å–Ω–æ, –Ω–µ –∫–ª—é—ë—Ç
    }
    
    # –°–µ–∑–æ–Ω–Ω—ã–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –ø–æ–≥–æ–¥—ã - –≤–µ–∑–¥–µ –≤—Å–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
    SEASONAL_WEATHER = {
        '–ó–∏–º–∞': {
            '–Ø—Å–Ω–æ': 0.20,          # –Ø—Å–Ω—ã–µ –º–æ—Ä–æ–∑–Ω—ã–µ –¥–Ω–∏
            '–û–±–ª–∞—á–Ω–æ': 0.18,       # –û–±–ª–∞—á–Ω–æ-—Ö–æ–ª–æ–¥–Ω–æ
            '–ü–∞—Å–º—É—Ä–Ω–æ': 0.12,      # –ü–∞—Å–º—É—Ä–Ω–æ
            '–î–æ–∂–¥—å': 0.08,         # –†–µ–¥–∫–∏–π –¥–æ–∂–¥—å –∏–ª–∏ –ª–µ–¥—è–Ω–æ–π –¥–æ–∂–¥—å –∑–∏–º–æ–π
            '–°–Ω–µ–≥': 0.32,          # –û—Å–Ω–æ–≤–Ω–∞—è –ø–æ–≥–æ–¥–∞ –∑–∏–º—ã
            '–¢—É–º–∞–Ω': 0.05,         # –†–µ–¥–∫–∏–π —Ç—É–º–∞–Ω
            '–ì—Ä–æ–∑–∞': 0.05          # –†–µ–¥–∫–∏–µ –≥—Ä–æ–∑—ã
        },
        '–í–µ—Å–Ω–∞': {
            '–Ø—Å–Ω–æ': 0.18,          # –Ø—Å–Ω—ã–µ –¥–Ω–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —á–∞—Å—Ç—ã–º–∏
            '–û–±–ª–∞—á–Ω–æ': 0.22,       # –û–±–ª–∞—á–Ω–æ-–ø–µ—Ä–µ–º–µ–Ω—á–∏–≤–æ
            '–ü–∞—Å–º—É—Ä–Ω–æ': 0.14,      # –ü–∞—Å–º—É—Ä–Ω–æ
            '–î–æ–∂–¥—å': 0.22,         # –ß–∞—Å—Ç—ã–µ –¥–æ–∂–¥–∏ –≤–µ—Å–Ω–æ–π
            '–°–Ω–µ–≥': 0.08,          # –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–Ω–µ–≥
            '–¢—É–º–∞–Ω': 0.08,         # –¢—É–º–∞–Ω –Ω–∞–¥ –≤–æ–¥–æ–π
            '–ì—Ä–æ–∑–∞': 0.08          # –í–µ—Å–µ–Ω–Ω–∏–µ –≥—Ä–æ–∑—ã
        },
        '–õ–µ—Ç–æ': {
            '–Ø—Å–Ω–æ': 0.28,          # –ß–∞—â–µ –≤—Å–µ–≥–æ —è—Å–Ω–æ
            '–û–±–ª–∞—á–Ω–æ': 0.20,       # –û–±–ª–∞—á–Ω–æ-—Ç–µ–ø–ª–æ
            '–ü–∞—Å–º—É—Ä–Ω–æ': 0.08,      # –†–µ–¥–∫–æ –ø–∞—Å–º—É—Ä–Ω–æ
            '–î–æ–∂–¥—å': 0.12,         # –õ–µ—Ç–Ω–∏–µ –¥–æ–∂–¥–∏ —Ä–µ–¥–∫–æ
            '–°–Ω–µ–≥': 0.02,          # –ö—Ä–∞–π–Ω–µ —Ä–µ–¥–∫–æ –≤ —Ä–∞–∑–≥–∞—Ä –ª–µ—Ç–∞
            '–¢—É–º–∞–Ω': 0.08,         # –£—Ç—Ä–µ–Ω–Ω–∏–π —Ç—É–º–∞–Ω
            '–ì—Ä–æ–∑–∞': 0.12          # –õ–µ—Ç–Ω–∏–µ –≥—Ä–æ–∑—ã
        },
        '–û—Å–µ–Ω—å': {
            '–Ø—Å–Ω–æ': 0.14,          # –†–µ–¥–∫–æ —è—Å–Ω–æ
            '–û–±–ª–∞—á–Ω–æ': 0.24,       # –ß–∞—Å—Ç–æ –æ–±–ª–∞—á–Ω–æ
            '–ü–∞—Å–º—É—Ä–Ω–æ': 0.18,      # –ü–∞—Å–º—É—Ä–Ω–æ - —Ç–∏–ø–∏—á–Ω–æ –¥–ª—è –æ—Å–µ–Ω–∏
            '–î–æ–∂–¥—å': 0.22,         # –ß–∞—Å—Ç—ã–µ –¥–æ–∂–¥–∏
            '–°–Ω–µ–≥': 0.08,          # –†–∞–Ω–Ω–∏–π —Å–Ω–µ–≥
            '–¢—É–º–∞–Ω': 0.10,         # –û—Å–µ–Ω–Ω–∏–π —Ç—É–º–∞–Ω
            '–ì—Ä–æ–∑–∞': 0.04          # –†–µ–¥–∫–æ –∫ –∫–æ–Ω—Ü—É –æ—Å–µ–Ω–∏
        }
    }
    
    # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ —Å–µ–∑–æ–Ω–∞–º
    SEASONAL_TEMPS = {
        '–ó–∏–º–∞': (-15, 0),
        '–í–µ—Å–Ω–∞': (5, 20),
        '–õ–µ—Ç–æ': (20, 35),
        '–û—Å–µ–Ω—å': (10, 25)
    }
    
    # –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–≥–æ–¥—ã
    WEATHER_TEMP_MODIFIERS = {
        '–Ø—Å–Ω–æ': (2, 8),          # –°–æ–ª–Ω—Ü–µ –Ω–∞–≥—Ä–µ–≤–∞–µ—Ç - –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ
        '–û–±–ª–∞—á–Ω–æ': (-1, 2),      # –û–±–ª–∞–∫–∞ –æ—Ö–ª–∞–∂–¥–∞—é—Ç –Ω–µ–º–Ω–æ–≥–æ
        '–ü–∞—Å–º—É—Ä–Ω–æ': (-3, 0),     # –ü–∞—Å–º—É—Ä–Ω–æ - —Ö–æ–ª–æ–¥–Ω–µ–µ
        '–î–æ–∂–¥—å': (-4, -1),       # –î–æ–∂–¥—å - –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Ö–æ–ª–æ–¥–Ω–µ–µ
        '–°–Ω–µ–≥': (-8, -3),        # –°–Ω–µ–≥ - –æ—á–µ–Ω—å —Ö–æ–ª–æ–¥–Ω–æ
        '–¢—É–º–∞–Ω': (-2, 1),        # –¢—É–º–∞–Ω - –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ
        '–ì—Ä–æ–∑–∞': (-5, 0),        # –ì—Ä–æ–∑–∞ - —Ö–æ–ª–æ–¥–Ω–∞—è, –Ω–µ—É—Å—Ç–æ–π—á–∏–≤–∞—è
    }
    
    @staticmethod
    def generate_weather(location: str) -> Tuple[str, int]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é –ø–æ–≥–æ–¥—É –¥–ª—è –ª–æ–∫–∞—Ü–∏–∏.

        –î–µ—Ç–µ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ 3-—á–∞—Å–æ–≤–æ–≥–æ –æ–∫–Ω–∞,
        —á—Ç–æ–±—ã /weather –∏ —Ä—ã–±–∞–ª–∫–∞ –≤—Å–µ–≥–¥–∞ —Å–æ–≤–ø–∞–¥–∞–ª–∏ –º–µ–∂–¥—É —Å–æ–±–æ–π.
        """
        season = get_current_season()
        now = datetime.now()
        bucket_hour = (now.hour // 3) * 3
        bucket_time = now.replace(hour=bucket_hour, minute=0, second=0, microsecond=0)

        seed_input = f"{location}|{season}|{bucket_time.isoformat()}"
        seed = int(hashlib.md5(seed_input.encode("utf-8")).hexdigest(), 16)
        rng = random.Random(seed)
        
        # –í—ã–±–∏—Ä–∞–µ–º –ø–æ–≥–æ–¥—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–µ–∑–æ–Ω–Ω—ã—Ö –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
        conditions = WeatherSystem.SEASONAL_WEATHER.get(season, {})
        weather = rng.choices(
            list(conditions.keys()),
            weights=list(conditions.values()),
            k=1
        )[0]
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–∞–∑–æ–≤—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Å–µ–∑–æ–Ω–∞
        min_temp, max_temp = WeatherSystem.SEASONAL_TEMPS.get(season, (10, 20))
        base_temp = rng.randint(min_temp, max_temp)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–≥–æ–¥—ã –∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ
        min_mod, max_mod = WeatherSystem.WEATHER_TEMP_MODIFIERS.get(weather, (0, 0))
        temp_modifier = rng.randint(min_mod, max_mod)
        final_temp = base_temp + temp_modifier
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö
        final_temp = max(-40, min(50, final_temp))
        
        return weather, final_temp
    
    @staticmethod
    def get_weather_bonus(weather_condition: str) -> int:
        """–ü–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å/—à—Ç—Ä–∞—Ñ –∫ —É–ª–æ–≤—É –∏–∑-–∑–∞ –ø–æ–≥–æ–¥—ã"""
        return WeatherSystem.WEATHER_CONDITIONS.get(weather_condition, {}).get('bonus', 0)
    
    @staticmethod
    def should_update_weather(last_update: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–∞ –ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã.

        –í–∞–∂–Ω–æ: –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º,
        —á—Ç–æ–±—ã —Ä–∞–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ –æ–¥–∏–Ω –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ –≤–∏–¥–µ–ª–∏ —Ä–∞–∑–Ω—É—é –ø–æ–≥–æ–¥—É.
        """
        if not last_update:
            return True
        
        last_time = datetime.fromisoformat(last_update)
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑ –≤ ~3 —á–∞—Å–∞ (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –¥–µ–Ω—å)
        update_interval = 180  # –≤ –º–∏–Ω—É—Ç–∞—Ö
        time_diff = (datetime.now() - last_time).total_seconds() / 60
        
        return time_diff > update_interval
    
    @staticmethod
    def get_weather_info(condition: str, temperature: int, season: str) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–≥–æ–¥–µ"""
        weather_info = WeatherSystem.WEATHER_CONDITIONS.get(condition, {})
        emoji = weather_info.get('emoji', 'üåç')
        name = weather_info.get('name', condition)
        
        return f"{emoji} {name}, {temperature}¬∞C"
    
    @staticmethod
    def get_weather_description(condition: str) -> str:
        """–û–ø–∏—Å–∞–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è –ø–æ–≥–æ–¥—ã –Ω–∞ —Ä—ã–±–∞–ª–∫—É"""
        descriptions = {
            '–Ø—Å–Ω–æ': '‚òÄÔ∏è –Ø—Ä–∫–æ–µ —Å–æ–ª–Ω—Ü–µ - —Ä—ã–±–∞ –ø—Ä—è—á–µ—Ç—Å—è –≥–ª—É–±–∂–µ, –∫–ª—ë–≤ —Å–ª–∞–±—ã–π',
            '–û–±–ª–∞—á–Ω–æ': '‚õÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å - –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è',
            '–ü–∞—Å–º—É—Ä–Ω–æ': '‚òÅÔ∏è –ü–∞—Å–º—É—Ä–Ω–æ - —Ä—ã–±–∞ –∞–∫—Ç–∏–≤–Ω–µ–µ, –æ—Ç–ª–∏—á–Ω—ã–π –∫–ª—ë–≤',
            '–î–æ–∂–¥—å': 'üåßÔ∏è –ò–¥—ë—Ç –¥–æ–∂–¥—å - —Ä—ã–±–∞ –æ—Ö–æ—Ç–Ω–æ –∫–ª—é—ë—Ç',
            '–°–Ω–µ–≥': '‚ùÑÔ∏è –°–Ω–µ–∂–Ω—ã–π –¥–µ–Ω—å - —É—Å–ª–æ–≤–∏—è —Ö–æ—Ä–æ—à–∏–µ',
            '–¢—É–º–∞–Ω': 'üå´Ô∏è –¢—É–º–∞–Ω –Ω–∞ –≤–æ–¥–µ - –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–π –∫–ª—ë–≤!',
            '–ì—Ä–æ–∑–∞': '‚õàÔ∏è –ì—Ä–æ–∑–∞! - –û–ø–∞—Å–Ω–æ —Ä—ã–±–∞—á–∏—Ç—å, —Ä—ã–±–∞ –Ω–µ –∫–ª—é—ë—Ç',
        }
        return descriptions.get(condition, f'–£—Å–ª–æ–≤–∏—è: {condition}')

weather_system = WeatherSystem()
